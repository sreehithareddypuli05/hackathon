<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Digital Health Record System</title>

  <!-- QR Code Generator -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
  <!-- QR Code Scanner -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; color: #333;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .header { text-align: center; color: white; margin-bottom: 30px; position: relative; }
    .login-btn {
      position: absolute; top: 20px; right: 20px;
      background: #28a745; color: white; border: none;
      padding: 10px 20px; border-radius: 8px; cursor: pointer;
      font-weight: 600;
    }
    .user-type-selection { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
    .user-type-card { background: rgba(255,255,255,0.95); border-radius: 15px; padding: 30px; cursor: pointer; transition: 0.3s; min-width: 250px; text-align: center; }
    .user-type-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    .module { background: rgba(255,255,255,0.95); border-radius: 15px; padding: 30px; margin-bottom: 20px; display: none; }
    .module.active { display: block; }
    .btn { padding: 10px 20px; border: none; border-radius: 8px; margin: 5px; cursor: pointer; font-weight: 600; }
    .btn-login { background: #28a745; color: white; }
    .btn-secondary { background: #6c757d; color: white; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; font-weight: 600; margin-bottom: 6px; }
    input, select {
      width: 100%; padding: 12px 15px; border: 2px solid #ddd; border-radius: 8px;
      font-size: 16px; transition: 0.3s; outline: none;
    }
    input:focus, select:focus {
      border-color: #667eea; box-shadow: 0 0 5px rgba(102,126,234,0.3);
    }
    #reader, #workerReader { width: 300px; margin: 20px auto; }
    .record-card { background: #f8f9fa; border: 1px solid #ddd; padding: 10px; border-radius: 6px; margin: 5px 0; }
    .file-upload { border: 2px dashed #667eea; border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; background: #f8f9fa; }
    .file-item { background: #fff; border: 1px solid #ddd; padding: 8px; border-radius: 6px; margin-bottom: 8px; }
    .search-filter { margin: 15px 0; display: flex; gap: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Digital Health Record Management</h1>
      <p>Secure access for Patients, Doctors, and Health Workers</p>
      <button class="login-btn" onclick="showLoginSelector()">Login</button>
    </div>

    <!-- User Type Selection -->
    <div class="user-type-selection">
      <div class="user-type-card" onclick="showModule('patient')">üßë‚Äç‚öïÔ∏è<h3>Patient Registration</h3></div>
      <div class="user-type-card" onclick="showModule('doctor')">üë®‚Äç‚öïÔ∏è<h3>Doctor</h3></div>
      <div class="user-type-card" onclick="showModule('worker')">üë∑<h3>Health Worker Module</h3></div>
    </div>

    <!-- Login Selector -->
    <div id="loginSelector" class="module">
      <h2>Login</h2>
      <button class="btn btn-login" onclick="showModule('patientLogin')">Patient Login</button>
      <button class="btn btn-login" onclick="showModule('doctorLogin')">Doctor Login</button>
      <button class="btn btn-login" onclick="showModule('workerLogin')">Health Worker Login</button>
    </div>

    <!-- Patient Registration -->
    <div id="patient" class="module">
      <h2>Patient Registration</h2>
      <div class="form-group"><label>Full Name *</label><input type="text" id="patientName"></div>
      <div class="form-group"><label>Phone Number *</label><input type="text" id="patientPhone"></div>
      <div class="form-group"><label>Aadhar Number *</label><input type="text" id="patientAadhar"></div>
      <div class="form-group"><label>Email (Optional)</label><input type="email" id="patientEmail"></div>
      <button class="btn btn-login" onclick="registerPatient()">Register & Generate QR</button>
      <div id="qrArea" style="display:none; margin-top:15px;">
        <h3>Your QR Code</h3>
        <div id="qrCode"></div>
      </div>
    </div>

    <!-- Patient Login -->
    <div id="patientLogin" class="module">
      <h2>Patient Login</h2>
      <div class="form-group"><label>Full Name</label><input type="text" id="loginPatientName"></div>
      <div class="form-group"><label>Phone Number</label><input type="text" id="loginPatientPhone"></div>
      <button class="btn btn-login" onclick="patientLogin()">Login</button>
    </div>

    <!-- Patient Dashboard -->
    <div id="patientDashboard" class="module">
      <h2>Patient Dashboard</h2>
      <div id="patientDetails"></div>
      <h3>Your QR Code</h3><div id="patientDashboardQR"></div>
      <div class="search-filter">
        <input type="text" id="patientSearch" placeholder="Search files...">
        <select id="patientFilter">
          <option value="all">All</option>
          <option value="doctor">Doctor</option>
          <option value="worker">Worker</option>
          <option value="patient">Patient</option>
        </select>
      </div>
      <h3>Your Files</h3><div id="patientFiles"></div>
      <h3>Upload Past Documents</h3>
      <div class="file-upload" id="patientUploadArea">üìÇ Upload your files<input type="file" id="patientFileInput" multiple style="display:none;"></div>
      <button class="btn btn-secondary" onclick="backToHome()">Back to Home</button>
    </div>

    <!-- Doctor Registration -->
    <div id="doctor" class="module">
      <h2>Doctor Registration</h2>
      <div class="form-group"><label>Doctor Name</label><input type="text" id="doctorName"></div>
      <div class="form-group"><label>Specialization</label>
        <select id="doctorSpec">
          <option value="General">General</option>
          <option value="Cardiology">Cardiology</option>
          <option value="Orthopedics">Orthopedics</option>
          <option value="Pediatrics">Pediatrics</option>
          <option value="Dermatology">Dermatology</option>
        </select>
      </div>
      <div class="form-group"><label>Hospital (Kerala)</label><input type="text" id="doctorHospital"></div>
      <button class="btn btn-login" onclick="registerDoctor()">Register</button>
    </div>

    <!-- Doctor Login -->
    <div id="doctorLogin" class="module">
      <h2>Doctor Login</h2>
      <div class="form-group"><label>Doctor ID</label><input type="text" id="loginDoctorID"></div>
      <button class="btn btn-login" onclick="doctorLogin()">Login</button>
    </div>

   <!-- Doctor Dashboard -->
<div id="doctorDashboard" class="module">
  <h2>Doctor Dashboard</h2>
  <div id="doctorProfile"></div>
  <div class="search-filter">
    <input type="text" id="doctorSearch" placeholder="Search files...">
    <select id="doctorFilter"></select>
  </div>
  <h3>Your Uploaded Files</h3><div id="doctorFiles"></div>
  
 
  <h3>Scan Patient QR</h3>
<button class="btn btn-login" onclick="startDoctorScan()">üì∑ Scan Patient QR</button>
<button id="doctorStopBtn" class="btn btn-secondary" style="display:none;" onclick="stopDoctorScan()">‚úñ Stop</button>
<div id="reader" style="display:none;"></div>

  <input type="file" id="doctorFileInput" multiple>
  <button class="btn btn-secondary" onclick="backToHome()">Logout</button>
</div>

    <!-- Worker Registration -->
    <div id="worker" class="module">
      <h2>Health Worker Registration</h2>
      <div class="form-group"><label>Name</label><input type="text" id="workerName"></div>
      <div class="form-group"><label>Phone</label><input type="text" id="workerPhone"></div>
      <button class="btn btn-login" onclick="registerWorker()">Register</button>
    </div>

    <!-- Worker Login -->
    <div id="workerLogin" class="module">
      <h2>Health Worker Login</h2>
      <div class="form-group"><label>Worker ID</label><input type="text" id="loginWorkerID"></div>
      <button class="btn btn-login" onclick="workerLogin()">Login</button>
    </div>

  

<!-- Worker Dashboard -->
<div id="workerDashboard" class="module">
  <h2>Health Worker Dashboard</h2>
  <div id="workerProfile"></div>
  <div class="search-filter">
    <input type="text" id="workerSearch" placeholder="Search files...">
    <select id="workerFilter"></select>
  </div>
  <h3>Your Uploaded Files</h3><div id="workerFiles"></div>
  
<h3>Scan Patient QR</h3>
<button class="btn btn-login" onclick="startWorkerScan()">üì∑ Scan Patient QR</button>
<button id="workerStopBtn" class="btn btn-secondary" style="display:none;" onclick="stopWorkerScan()">‚úñ Stop</button>
<div id="workerReader" style="display:none;"></div>

  <input type="file" id="workerFileInput" multiple>
  <button class="btn btn-secondary" onclick="backToHome()">Logout</button>
</div>

  <script>
    /* LocalStorage */
    let patients = JSON.parse(localStorage.getItem("patients")) || {};
    let doctors = JSON.parse(localStorage.getItem("doctors")) || {};
    let workers = JSON.parse(localStorage.getItem("workers")) || {};

    function saveData(){
      localStorage.setItem("patients", JSON.stringify(patients));
      localStorage.setItem("doctors", JSON.stringify(doctors));
      localStorage.setItem("workers", JSON.stringify(workers));
    }

    let currentPatient=null, currentDoctor=null, currentWorker=null;
    let scanner, workerScanner;

    function showModule(id){
      document.querySelectorAll(".module").forEach(m=>m.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }
    function showLoginSelector(){showModule("loginSelector");}
    function backToHome(){location.reload();}

    /* ========== PATIENT ========= */
    function registerPatient(){
      let name=document.getElementById("patientName").value.trim();
      let phone=document.getElementById("patientPhone").value.trim();
      let aadhar=document.getElementById("patientAadhar").value.trim();
      let email=document.getElementById("patientEmail").value.trim();
      if(!name||!phone||!aadhar){alert("Fill all required fields");return;}
      if(phone.length!==10){alert("Phone must be 10 digits");return;}
      if(aadhar.length!==12){alert("Aadhar must be 12 digits");return;}
      patients[aadhar]={name,phone,aadhar,email,files:[]};
      saveData();
      let qr=qrcode(0,'M'); qr.addData(JSON.stringify({aadhar})); qr.make();
      document.getElementById("qrCode").innerHTML=qr.createImgTag(6);
      document.getElementById("qrArea").style.display="block";
      alert("Registered! Use Aadhar to login.");
    }
    function patientLogin(){
      let name=document.getElementById("loginPatientName").value.trim();
      let phone=document.getElementById("loginPatientPhone").value.trim();
      let found=Object.values(patients).find(p=>p.name===name&&p.phone===phone);
      if(!found){alert("Patient not found");return;}
      currentPatient=found; showPatientDashboard();
    }
    function showPatientDashboard(){
      showModule("patientDashboard");
      document.getElementById("patientDetails").innerHTML=`<p><b>Name:</b> ${currentPatient.name}</p><p><b>Phone:</b> ${currentPatient.phone}</p><p><b>Aadhar:</b> ${currentPatient.aadhar}</p>`;
      let qr=qrcode(0,'M'); qr.addData(JSON.stringify({aadhar:currentPatient.aadhar})); qr.make();
      document.getElementById("patientDashboardQR").innerHTML=qr.createImgTag(4);
      renderPatientFiles();
    }
    function renderPatientFiles(){
      let list=document.getElementById("patientFiles"); list.innerHTML="";
      let search=document.getElementById("patientSearch").value.toLowerCase();
      let filter=document.getElementById("patientFilter").value;
      let files=currentPatient.files.filter(f=>(f.name.toLowerCase().includes(search))&&(filter==="all"||f.uploader.includes(filter)));
      if(files.length===0) list.innerHTML="<p>No matching files</p>";
      files.forEach(f=>{list.innerHTML+=`<div class="record-card">${f.name} (${Math.round(f.size/1024)} KB) <i>by ${f.uploader}</i></div>`;});
    }
    document.getElementById("patientSearch").addEventListener("input",renderPatientFiles);
    document.getElementById("patientFilter").addEventListener("change",renderPatientFiles);
    document.getElementById("patientUploadArea").addEventListener("click",()=>document.getElementById("patientFileInput").click());
    document.getElementById("patientFileInput").addEventListener("change",e=>{
      let files=Array.from(e.target.files);
      files.forEach(file=>{currentPatient.files.push({name:file.name,size:file.size,uploader:"patient"});});
      patients[currentPatient.aadhar]=currentPatient; saveData(); renderPatientFiles();
    });

    /* ========== DOCTOR ========= */
    function registerDoctor(){
      let name=document.getElementById("doctorName").value.trim();
      let spec=document.getElementById("doctorSpec").value;
      let hospital=document.getElementById("doctorHospital").value.trim();
      if(!name||!hospital){alert("Fill all fields");return;}
      let id="DOC"+Math.floor(1000+Math.random()*9000);
      doctors[id]={id,name,spec,hospital,files:[]};
      saveData();
      alert("Doctor registered! ID: "+id);
    }
    function doctorLogin(){
      let id=document.getElementById("loginDoctorID").value.trim();
      if(!doctors[id]){alert("Invalid ID");return;}
      currentDoctor=doctors[id]; showDoctorDashboard();
    }
    function showDoctorDashboard(){
      showModule("doctorDashboard");
      document.getElementById("doctorProfile").innerHTML=`<p><b>Name:</b> ${currentDoctor.name}</p><p><b>Specialization:</b> ${currentDoctor.spec}</p><p><b>Hospital:</b> ${currentDoctor.hospital}</p><p><b>ID:</b> ${currentDoctor.id}</p>`;
      let filter=document.getElementById("doctorFilter"); filter.innerHTML="<option value='all'>All Patients</option>";
      let uniquePatients=[...new Set(currentDoctor.files.map(f=>f.patientAadhar))];
      uniquePatients.forEach(a=>filter.innerHTML+=`<option value='${a}'>${a}</option>`);
      renderDoctorFiles();
    }
    function renderDoctorFiles(){
      let list=document.getElementById("doctorFiles"); list.innerHTML="";
      let search=document.getElementById("doctorSearch").value.toLowerCase();
      let filter=document.getElementById("doctorFilter").value;
      let files=currentDoctor.files.filter(f=>(f.name.toLowerCase().includes(search))&&(filter==="all"||f.patientAadhar===filter));
      if(files.length===0) list.innerHTML="<p>No matching files</p>";
      files.forEach(f=>{list.innerHTML+=`<div class="record-card">${f.name} (for ${f.patientAadhar})</div>`;});
    }
    document.getElementById("doctorSearch").addEventListener("input",renderDoctorFiles);
    document.getElementById("doctorFilter").addEventListener("change",renderDoctorFiles);
    document.getElementById("doctorFileInput").addEventListener("change",e=>{
      let files=Array.from(e.target.files);
      let aadhar=prompt("Enter patient Aadhar to attach files:");
      if(!patients[aadhar]){alert("Invalid patient");return;}
      files.forEach(file=>{
        let rec={name:file.name,size:file.size,uploader:"doctor-"+currentDoctor.id,patientAadhar:aadhar};
        patients[aadhar].files.push(rec); currentDoctor.files.push(rec);
      });
      saveData(); renderDoctorFiles();
    });

    /* ========== WORKER ========= */
    function registerWorker(){
      let name=document.getElementById("workerName").value.trim();
      let phone=document.getElementById("workerPhone").value.trim();
      if(!name||!phone){alert("Fill all fields");return;}
      if(phone.length!==10){alert("Phone must be 10 digits");return;}
      let id="WRK"+Math.floor(1000+Math.random()*9000);
      workers[id]={id,name,phone,files:[]}; saveData();
      alert("Worker registered! ID: "+id);
    }
    function workerLogin(){
      let id=document.getElementById("loginWorkerID").value.trim();
      if(!workers[id]){alert("Invalid ID");return;}
      currentWorker=workers[id]; showWorkerDashboard();
    }
    function showWorkerDashboard(){
      showModule("workerDashboard");
      document.getElementById("workerProfile").innerHTML=`<p><b>Name:</b> ${currentWorker.name}</p><p><b>Phone:</b> ${currentWorker.phone}</p><p><b>ID:</b> ${currentWorker.id}</p>`;
      let filter=document.getElementById("workerFilter"); filter.innerHTML="<option value='all'>All Patients</option>";
      let uniquePatients=[...new Set(currentWorker.files.map(f=>f.patientAadhar))];
      uniquePatients.forEach(a=>filter.innerHTML+=`<option value='${a}'>${a}</option>`);
      renderWorkerFiles();
    }
    function renderWorkerFiles(){
      let list=document.getElementById("workerFiles"); list.innerHTML="";
      let search=document.getElementById("workerSearch").value.toLowerCase();
      let filter=document.getElementById("workerFilter").value;
      let files=currentWorker.files.filter(f=>(f.name.toLowerCase().includes(search))&&(filter==="all"||f.patientAadhar===filter));
      if(files.length===0) list.innerHTML="<p>No matching files</p>";
      files.forEach(f=>{list.innerHTML+=`<div class="record-card">${f.name} (for ${f.patientAadhar})</div>`;});
    }
    document.getElementById("workerSearch").addEventListener("input",renderWorkerFiles);
    document.getElementById("workerFilter").addEventListener("change",renderWorkerFiles);
    document.getElementById("workerFileInput").addEventListener("change",e=>{
      let files=Array.from(e.target.files);
      let aadhar=prompt("Enter patient Aadhar to attach files:");
      if(!patients[aadhar]){alert("Invalid patient");return;}
      files.forEach(file=>{
        let rec={name:file.name,size:file.size,uploader:"worker-"+currentWorker.id,patientAadhar:aadhar};
        patients[aadhar].files.push(rec); currentWorker.files.push(rec);
      });
      saveData(); renderWorkerFiles();
    });
    /* Doctor QR Scan */
/* Doctor QR Scan */
/* Doctor QR Scan */
function startDoctorScan() {
  document.getElementById("reader").style.display = "block";
  document.getElementById("doctorStopBtn").style.display = "inline-block";
  if (scanner) { scanner.clear(); }
  scanner = new Html5Qrcode("reader");

  scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, decodedText => {
    try {
      let data = JSON.parse(decodedText);
      if (patients[data.aadhar]) {
        currentPatient = patients[data.aadhar]; // set current patient
        stopDoctorScan();
        showPatientDashboard(); // redirect to patient dashboard
      } else {
        alert("Patient not found!");
      }
    } catch (e) { alert("Invalid QR"); stopDoctorScan(); }
  });
}

function stopDoctorScan(){
  if(scanner){
    scanner.stop().then(()=>{
      document.getElementById("reader").style.display="none";
      document.getElementById("doctorStopBtn").style.display="none";
    });
  }
}

/* Worker QR Scan *//* Worker QR Scan */
function startWorkerScan() {
  document.getElementById("workerReader").style.display = "block";
  document.getElementById("workerStopBtn").style.display = "inline-block";
  if (workerScanner) { workerScanner.clear(); }
  workerScanner = new Html5Qrcode("workerReader");

  workerScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, decodedText => {
    try {
      let data = JSON.parse(decodedText);
      if (patients[data.aadhar]) {
        currentPatient = patients[data.aadhar]; // set current patient
        stopWorkerScan();
        showPatientDashboard(); // redirect to patient dashboard
      } else {
        alert("Patient not found!");
        stopWorkerScan();
      }
    } catch (e) {
      alert("Invalid QR");
      stopWorkerScan();
    }
  });
}

function stopWorkerScan(){
  if(workerScanner){
    workerScanner.stop().then(()=>{
      document.getElementById("workerReader").style.display="none";
      document.getElementById("workerStopBtn").style.display="none";
    });
  }
}


  </script>
</body>
</html>
